<!DOCTYPE html>
<html lang="en">
  <head>
    <title>File/Folder view - Fsh Pterodactyl Panel</title>
    <!-- Boiler plate------ -->
    <link rel="icon" href="https://fsh.plus/fsh.png" type="image/png">
    <meta name="description" content="A pterodactyl panel replacement. View a file or folder (login required).">
    <!-- ------- -->
    <link rel="stylesheet" href="https://fsh.plus/media/style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://fsh.plus/fsh.png"/>
    <meta name="theme-color" content="#a89c9b">
    <!-- ------------------ -->
    <link rel="stylesheet" href="/media/style.css">
    <script src="/media/script.js"></script>
    <script src="https://kit.fontawesome.com/50eb963274.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
  </head>
  <body>
    <main>
      <dialog id="fe">
        <p>For all:</p>
        <button onclick="Frename()">Rename</button>
        <br>
        <button onclick="Fdelete()">Delete</button>
        <br>
        <button onclick="Fzip()">Compress</button>
        <hr>
        <p>Files:</p>
        <button onclick="Fdownload()">Download</button>
        <br>
        <button onclick="Fduplicate()">Duplicate</button>
        <hr>
        <p>For compressed:</p>
        <button onclick="Funzip()">Decompress</button>
      </dialog>
      <p id="KP">server/</p>
      <div id="KB" style="display:none">
        <button onclick="Ffolderc()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256"><path fill-rule="evenodd" clip-rule="evenodd" d="M20 19C8.95431 19 0 27.9543 0 39V217C0 228.046 8.95431 237 20 237H236C247.046 237 256 228.046 256 217V65C256 53.9543 247.046 45 236 45H140.515C135.075 45 129.869 42.7837 126.098 38.8622L112.902 25.1378C109.131 21.2163 103.925 19 98.4851 19H20ZM113.352 79.6484C113.352 71.5583 119.91 65 128 65C136.09 65 142.648 71.5583 142.648 79.6484V125.352H188.352C196.442 125.352 203 131.91 203 140C203 148.09 196.442 154.648 188.352 154.648H142.648V200.352C142.648 208.442 136.09 215 128 215C119.91 215 113.352 208.442 113.352 200.352V154.648H67.6484C59.5583 154.648 53 148.09 53 140C53 131.91 59.5583 125.352 67.6484 125.352H113.352V79.6484Z"></path></svg> Create folder</button>
        <a onclick="Ffilec()"><button><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256"><path fill-rule="evenodd" clip-rule="evenodd" d="M52.2895 5C41.6362 5 33 13.6362 33 24.2895V232.616C33 243.269 41.6362 251.905 52.2895 251.905H204.033C214.687 251.905 223.323 243.269 223.323 232.616V94.1579C223.323 87.5305 217.95 82.1579 211.323 82.1579H165.454C154.801 82.1579 146.165 73.5217 146.165 62.8684V17C146.165 10.3726 140.792 5 134.165 5H52.2895ZM156.333 15.0465C156.333 11.4829 160.642 9.69822 163.162 12.2181L216.505 65.5612C219.025 68.0811 217.24 72.3896 213.677 72.3896H166.333C160.811 72.3896 156.333 67.9125 156.333 62.3896V15.0465ZM115.293 115.207C115.293 108.465 120.758 103 127.5 103C134.242 103 139.707 108.465 139.707 115.207V153.293H177.793C184.535 153.293 190 158.758 190 165.5C190 172.242 184.535 177.707 177.793 177.707H139.707V215.793C139.707 222.535 134.242 228 127.5 228C120.758 228 115.293 222.535 115.293 215.793V177.707H77.207C70.4653 177.707 65 172.242 65 165.5C65 158.758 70.4653 153.293 77.207 153.293H115.293V115.207Z"></path></svg> Create file</button></a>
        <button onclick="Fupload()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256"><path d="M129 14.6569C129 11.0932 133.309 9.30857 135.828 11.8284L189.172 65.1716C191.691 67.6914 189.907 72 186.343 72H139C133.477 72 129 67.5228 129 62V14.6569Z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M183.571 117.072C179.666 113.166 173.334 113.166 169.429 117.072L134.196 152.304C132.312 154.123 131.14 156.675 131.14 159.5C131.14 159.585 131.141 159.668 131.143 159.752C131.17 162.275 132.146 164.791 134.071 166.716L169.426 202.072C173.332 205.977 179.663 205.977 183.569 202.072C187.474 198.166 187.474 191.835 183.569 187.929L165.14 169.5H245.64C251.162 169.5 255.64 165.023 255.64 159.5C255.64 153.978 251.162 149.5 245.64 149.5H165.284L183.571 131.214C187.476 127.308 187.476 120.977 183.571 117.072Z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M5.6665 23.8998C5.6665 13.2465 14.3027 4.61035 24.956 4.61035H106.831C113.459 4.61035 118.831 9.98294 118.831 16.6104V62.4788C118.831 73.1321 127.468 81.7683 138.121 81.7683H183.989C190.617 81.7683 195.989 87.1409 195.989 93.7683V142H182.578L188.562 135.865C195.408 128.847 195.408 117.468 188.562 110.45C181.716 103.432 170.616 103.432 163.77 110.45L128.333 146.777C121.487 153.795 121.487 165.174 128.333 172.193C128.872 172.745 129.437 173.254 130.024 173.719L163.087 207.612C169.888 214.585 180.916 214.585 187.717 207.612C194.519 200.64 194.519 189.335 187.717 182.362L182.486 177H195.989V232.226C195.989 242.88 187.353 251.516 176.7 251.516H24.956C14.3027 251.516 5.6665 242.88 5.6665 232.226V23.8998Z"/></svg> Upload</button>
        <input id="upload" type="file" style="display:none">
      </div>
      <div style="display:flex;height:90vh;">
        <div style="flex:1" id="cont"></div>
      </div>
      <button id="SB" onclick="Fsav()" style="font-size:18px;position:fixed;bottom:0;right:12px;display:none;">Save</button>
      <script>
        const params = new URLSearchParams(location.search);
        document.getElementById('KP').innerHTML = `<a href="/user/server?id=${params.get('id')}">server</a>${params.get('file').split('/').slice(0,params.get('file').split('/').length-1).map(r=>{return `<a href="/user/server/file?id=${params.get('id')}&file=${params.get('file').split(r)[0]}${r}&f=false">${r}</a>`}).join('/')}/${params.get('file').split('/').slice(-1)[0]}`.replace('//','/');
        function fe(name) {
          modal = name;
          document.getElementById('fe').showModal();
        }
        function files() {
          PT(`servers/${params.get('id')}/files/list?directory=${params.get('file')}`, function(f){
            f = f.data;
            document.getElementById('cont').innerHTML = f.sort().map(o => {
              o = o.attributes;
              return `<p class="file">
  <a href="/user/server/file?id=${params.get('id')}&file=${params.get('file')}/${o.name}&f=${o.is_file}&mime=${o.mimetype}">
    ${o.is_file ? file_type(o.mimetype, o.name) : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 39C0 27.9543 8.95431 19 20 19H98.4851C103.925 19 109.131 21.2163 112.902 25.1378L126.098 38.8622C129.869 42.7837 135.075 45 140.515 45H236C247.046 45 256 53.9543 256 65V217C256 228.046 247.046 237 236 237H20C8.95431 237 0 228.046 0 217V39Z"></path></svg>'} ${o.name}${o.is_file ? `&nbsp;&nbsp;&nbsp;${formatBytes(o.size)}` : ''}<span style="flex:1"></span><code>${o.mode}</code>
  </a>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 256 256" style="cursor:pointer;margin-right:5px;padding:2px;" onclick="fe('${o.name}')"><path fill-rule="evenodd" clip-rule="evenodd" d="M128 158C111.431 158 98 144.569 98 128C98 111.431 111.431 98 128 98C144.569 98 158 111.431 158 128C158 144.569 144.569 158 128 158ZM128 60C111.432 60 98.0001 46.5685 98.0001 30C98.0001 13.4315 111.432 3.66562e-07 128 -3.57672e-07C144.569 -1.08191e-06 158 13.4315 158 30C158 46.5685 144.569 60 128 60ZM98 226C98 242.569 111.431 256 128 256C144.569 256 158 242.569 158 226C158 209.431 144.569 196 128 196C111.431 196 98 209.431 98 226Z"/></svg>
</p>`;
            }).join('')
          })
        }
        if (params.get('f') == 'false') {
          document.getElementById('KB').style.display = "";
          files();
        } else {
          PT(`servers/${params.get('id')}/files/contents?file=${params.get('file')}`, function(fd, alt){
            if (params.get('mime')) {
              let typ = params.get('mime').split('/')[0];
              switch(typ) {
                case 'image':
                  document.getElementById('cont').innerHTML = `<img src="${alt}">`;
                  return;
                case 'audio':
                  document.getElementById('cont').innerHTML = `<audio src="${alt}"></audio>`;
                  return;
                case 'video':
                  document.getElementById('cont').innerHTML = `<video src="${alt}"></video>`;
                  return;
              }
            }
            document.getElementById('SB').style.display = "";
            let lang = params.get('file').split('.').slice(-1)[0];
            let ch = {
              js: 'javascript',
              cjs: 'javascript',
              mjs: 'javascript',
              ts: 'typescript',
              tsx: 'typescript',
              py: 'python'
            }
            if (Object.keys(ch).includes(lang)) {
              lang = ch[lang]
            }
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor/min/vs' } });
            require(['vs/editor/editor.main'], function() {
              monaco.editor.create(document.getElementById('cont'), {
                value: fd,
                language: lang,
                scrollBeyondLastLine: true,
                readOnly: false,
                automaticLayout: true,
                minimap: {enabled: false},
                theme: "vs-dark"
              });
              window.monaco.editor.getEditors()[0].getModel().updateOptions({ tabSize: 2 })
            })
          }, 'GET', '', (params.get('mime')??''))
        }
        function Frename() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/rename`, function(){files()}, 'PUT', `{
  "root": "/${params.get('file')}",
  "files": [
    {
      "from": "${modal}",
      "to": "${prompt('New name', modal)}"
    }
  ]
}`)
        }
        function Ffolderc() {
          PT(`servers/${params.get('id')}/files/create-folder`, function(){files()}, 'POST', JSON.stringify({
  root: `/${params.get('file')}`,
  name: prompt('Folder name')
}))
        }
        function Ffilec() {
          PT(`servers/${params.get('id')}/files/write?file=${params.get('file')}/${prompt('File name')}`, function(){files()}, 'POST', '')
        }
        function Fupload() {
          document.getElementById('upload').click();
        }
        document.getElementById('upload').onchange = function(event){
          PT(`servers/${params.get('id')}/files/upload`, function(e){
            let data = new FormData();
            for (let file of event.target.files) {
              data.append('files', file);
            }
            fetch(`${e.attributes.url}&directory=${encodeURIComponent(params.get('file'))}`, {
              method: 'POST',
              body: data
            })
              .then(res=>res.text())
              .then(_=>files());
          })
        }
        function Fdownload() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/download?file=${params.get('file')}/${modal}`, function(e){window.open(e.attributes.url)})
        }
        function Fduplicate() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/copy`, function(){files()}, 'POST', JSON.stringify({ location: `/${params.get('file')}/${modal}` }))
        }
        function Fdelete() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/delete`, function(){files()}, 'POST', `{
  "root": "/${params.get('file')}",
  "files": [
    "${modal}"
  ]
}`)
        }
        function Fzip() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/compress`, function(){files()}, 'POST', `{
  "root": "/${params.get('file')}",
  "files": [
    "${modal}"
  ]
}`)
        }
        function Funzip() {
          document.getElementById('fe').close();
          PT(`servers/${params.get('id')}/files/decompress`, function(){files()}, 'POST', `{
  "root": "/${params.get('file')}",
  "file": "${modal}"
}`)
        }
        function Fsav() {
          PT(`servers/${params.get('id')}/files/write?file=${params.get('file')}`, ()=>{}, 'POST', encodeURIComponent(window.monaco.editor.getEditors()[0].getValue()))
        }
      </script>
    </main>
  </body>
</html>