<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Server view - Fsh Pterodactyl Panel</title>
    <!-- Boiler plate------ -->
    <link rel="icon" href="https://fsh.plus/fsh.png" type="image/png">
    <meta name="description" content="A pterodactyl panel replacement. View a server (login required).">
    <!-- ------- -->
    <link rel="stylesheet" href="https://fsh.plus/media/style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:image" content="https://fsh.plus/fsh.png"/>
    <meta name="theme-color" content="#a89c9b">
    <!-- ------------------ -->
    <link rel="stylesheet" href="/media/style.css">
    <script src="/media/script.js"></script>
    <script src="https://kit.fontawesome.com/50eb963274.js" crossorigin="anonymous"></script>
    <style>
      #state {
        flex-grow: 1;
        border-left: 8px var(--status) solid;
        border-radius: 0.5rem;
        padding-left: 8px;
      }
      .vals {
        display: flex;
        max-width: 100vw;
        flex-wrap: wrap;
      }
      .vals div {
        background-color: var(--bg-2);
        padding: 8px;
        margin: 5px;
        border-radius: 1rem;
      }
      .big button {
        height: 40px;
        aspect-ratio: 1/1;
        font-size: 20px;
        margin: 4px;
      }
      dialog {
        min-width: 10%;
      }
      .console {
        display: flex;
        flex-direction: column;
        height: 45vh;
        margin: 10px;
        padding: 10px;
        border-radius: 1rem;
        background-color: var(--bg-2);
        box-sizing: border-box;
      }
      #console-output {
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <a href="/user/servers"><button>Back</button></a>
    <div style="display:flex">
      <div id="state">
        <h1 id="name">Name</h1>
        <label id="desc">Desc</label>
        <label id="node" class="subtext">Node</label>
      </div>
      <div style="display:flex;align-items:center;flex-wrap:wrap;" class="big">
        <button onclick="power('start')"><i class="fa-solid fa-play"></i></button>
        <button onclick="power('restart')"><i class="fa-solid fa-rotate-right"></i></button>
        <button onclick="power('stop')"><i class="fa-solid fa-stop"></i></button>
        <button onclick="power('kill')" style="background-color:#c00"><i class="fa-solid fa-skull"></i></button>
      </div>
    </div>
    <div class="vals">
      <div>
        <i class="fa-solid fa-microchip"></i>
        <label id="cpu">0%/0%</label>
      </div>
      <div>
        <i class="fa-solid fa-memory"></i>
        <label id="ram">0B/0B</label>
      </div>
      <div>
        <i class="fa-solid fa-hard-drive"></i>
        <label id="disk">0B/0B</label>
      </div>
      <div>
        <i class="fa-solid fa-cloud-arrow-down"></i>
        <label id="rx">0B</label>
      </div>
      <div>
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <label id="tx">0B</label>
      </div>
      <div style="cursor:pointer">
        <i class="fa-solid fa-network-wired"></i>
        <a id="uop" target="_blank" style="color:#fff;text-decoration:none;"><label id="url" style="cursor:pointer">URL</label></a>
      </div>
      <div>
        <i class="fa-solid fa-clock"></i>
        <label id="up">0s</label>
      </div>
    </div>
    <div>
      <a id="Bfiles"><button>Files</button></a>
      <a id="Bdat"><button disabled>Databases</button></a>
      <a id="Bsch"><button disabled>Schedules</button></a>
      <a id="Busr"><button disabled>Users</button></a>
      <a id="Bbku"><button disabled>Backups</button></a>
      <a id="Bnet"><button>Network</button></a>
      <a id="Bsta"><button disabled>Startup</button></a>
      <a id="Bset"><button disabled>Settings</button></a>
      <a id="Bact"><button>Activity</button></a>
    </div>
    <div class="console">
      <p id="console-output"></p>
      <span>
        <input placeholder="Server command" onkeyup="if(event.key==='Enter'){comm(this.value);this.value=''}">
        <button>Sned</button>
      </span>
    </div>
    <script>
      const params = new URLSearchParams(location.search);

      // Console
      let pt_console = new EventSource(`https://api.fsh.plus/pt-console?id=${params.get('id')}&host=${localStorage.getItem('domain')}&key=${localStorage.getItem('key')}`)

      pt_console.onmessage = (event) => {
        let ev = JSON.parse(event.data);
        if (ev.event == 'stats') {
          let s = JSON.parse(ev.args[0]);
          document.getElementById('state').classList.add('status-'+s.state);
          document.getElementById('cpu').innerHTML = s.cpu_absolute+'%'+document.getElementById('cpu').innerHTML.split('%')[1];
          document.getElementById('ram').innerHTML = `${formatBytes(s.memory_bytes)}/${s.memory_limit_bytes == 0 ? '∞' : formatBytes(s.memory_limit_bytes)}`;
          document.getElementById('disk').innerHTML = formatBytes(s.disk_bytes)+'/'+document.getElementById('disk').innerHTML.split('/')[1];
          document.getElementById('rx').innerHTML = formatBytes(s.network.rx_bytes);
          document.getElementById('tx').innerHTML = formatBytes(s.network.tx_bytes);
          document.getElementById('up').innerHTML = time_gud(Math.floor(s.uptime/1000));
        } else if (ev.event == 'console output') {
          document.getElementById('console-output').insertAdjacentHTML('beforeend', ev.args.map(e=>`<p>${e}</p>`).join());
        } else {
          document.getElementById('console-output').insertAdjacentHTML('beforeend', event.data);
        }
      };

      // Pages
      document.getElementById('Bfiles').href = '/user/server/file?id='+params.get('id')+'&file=/&f=false';
      //document.getElementById('Bdat').href = '/user/server/databases?id='+params.get('id');
      //document.getElementById('Bsch').href = '/user/server/schedules?id='+params.get('id');
      //document.getElementById('Busr').href = '/user/server/users?id='+params.get('id');
      //document.getElementById('Bbku').href = '/user/server/backups?id='+params.get('id');
      document.getElementById('Bnet').href = '/user/server/network?id='+params.get('id');
      //document.getElementById('Bsta').href = '/user/server/startup?id='+params.get('id');
      //document.getElementById('Bset').href = '/user/server/settings?id='+params.get('id');
      document.getElementById('Bact').href = '/user/server/activity?id='+params.get('id');
      PT('servers/'+params.get('id'), function(s){
        s = s.attributes;
        if (s.is_suspended) {
          location.href = '/user/servers';
          return;
        }
        PT('servers/'+params.get('id')+'/resources', function(d){
          d = d.attributes;
          document.getElementById('name').innerHTML = s.name;
          document.getElementById('desc').innerHTML = s.description;
          document.getElementById('node').innerHTML = s.node;
          document.getElementById('state').classList.add(s.is_installing ? 'status-installing' : 'status-'+d.current_state);
          document.getElementById('url').innerHTML = `${s.relationships.allocations.data[0].attributes.ip_alias || s.relationships.allocations.data[0].attributes.ip}:${s.relationships.allocations.data[0].attributes.port}`;
          document.getElementById('uop').href = `http://${s.relationships.allocations.data[0].attributes.ip_alias || s.relationships.allocations.data[0].attributes.ip}:${s.relationships.allocations.data[0].attributes.port}`;
          document.getElementById('cpu').innerHTML = `${d.resources.cpu_absolute}%/${s.limits.cpu == 0 ? '∞' : s.limits.cpu}%`;
          document.getElementById('ram').innerHTML = `${formatBytes(d.resources.memory_bytes)}/${s.limits.memory == 0 ? '∞' : formatBytes(s.limits.memory)}`;
          document.getElementById('disk').innerHTML = `${formatBytes(d.resources.disk_bytes)}/${s.limits.disk == 0 ? '∞' : formatBytes(s.limits.disk*1024*1024)}`;
          document.getElementById('rx').innerHTML = formatBytes(d.resources.network_rx_bytes);
          document.getElementById('tx').innerHTML = formatBytes(d.resources.network_tx_bytes);
          document.getElementById('up').innerHTML = time_gud(Math.floor(d.resources.uptime/1000));
        })
      })
      function power(ac) {
        PT('servers/'+params.get('id')+'/power', function(){return}, 'POST', `{"signal": "${ac}"}`)
      }
      function comm(val) {
        PT('servers/'+params.get('id')+'/command', function(){return}, 'POST', JSON.stringify({command: val}))
      }
    </script>
  </body>
</html>
